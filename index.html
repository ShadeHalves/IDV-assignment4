<script>
// ---------------- Metric / dataset config -----------------
const metricConfig = {
  standard: {
    key: "standard",
    label: "Standard Accuracy (%)"
  },
  crr: {
    key: "crr",
    label: "Certified Robustness Rate (%)"
  },
  cra: {
    key: "cra",
    label: "Certified Robust Accuracy (%)"
  }
};

const datasets = ["CIFAR-100", "CIFAR-10", "SVHN", "MNIST"];

let currentMetric = "standard";
let currentDataset = "MNIST";   // 你现在默认选的是 MNIST，就沿用

// ---------------- Load JSON data -----------------
d3.json("data_1.json").then(initChart);

function initChart(data) {
  const svg = d3.select("#chart");
  const width  = +svg.attr("width");
  const height = +svg.attr("height");

  const margin = { top: 40, right: 30, bottom: 70, left: 70 };
  const innerWidth  = width  - margin.left - margin.right;
  const innerHeight = height - margin.top  - margin.bottom;

  const g = svg.append("g")
               .attr("transform", `translate(${margin.left},${margin.top})`);

  const approaches = data.map(d => d.approach);

  // 同一种方法使用同样的颜色
  const color = d3.scaleOrdinal()
      .domain(approaches)
      .range(d3.schemeTableau10.concat(d3.schemeSet3)); // 足够颜色

  const x = d3.scaleBand()
      .domain(approaches)
      .range([0, innerWidth])
      .padding(0.2);

  const y = d3.scaleLinear()
      .range([innerHeight, 0]);

  // x 轴
  g.append("g")
    .attr("transform", `translate(0,${innerHeight})`)
    .call(d3.axisBottom(x))
    .selectAll("text")
      .attr("transform", "rotate(-35)")
      .style("text-anchor", "end");

  // y 轴 group
  const yAxisG = g.append("g").attr("class", "y-axis");

  // y 轴标题
  const yLabel = g.append("text")
      .attr("x", -innerHeight / 2)
      .attr("y", -48)
      .attr("transform", "rotate(-90)")
      .attr("text-anchor", "middle")
      .style("font-size", 13)
      .text(metricConfig[currentMetric].label + " – " + currentDataset);

  const tooltip = d3.select("#tooltip");

  // 每根柱子直接绑定整行数据 row
  const bars = g.selectAll("rect.bar")
      .data(data)
      .enter()
      .append("rect")
      .attr("class", "bar")
      .attr("x", d => x(d.approach))
      .attr("width", x.bandwidth())
      .attr("y", innerHeight)   // 先从 0 高度开始
      .attr("height", 0)
      .attr("fill", d => color(d.approach))
      .on("mousemove", (event, d) => {
        const val = d[metricConfig[currentMetric].key][currentDataset];
        tooltip.style("opacity", 1)
          .style("left", (event.pageX + 10) + "px")
          .style("top",  (event.pageY + 10) + "px")
          .html(`<b>${d.approach}</b><br/>
                 Metric: ${metricConfig[currentMetric].label}<br/>
                 Dataset: ${currentDataset}<br/>
                 Value: ${val.toFixed(2)}`);
      })
      .on("mouseleave", () => tooltip.style("opacity", 0));

  // 更新 y 轴 + 柱子高度
  function updateChart(animate = true) {
    const metricKey = metricConfig[currentMetric].key;

    const values = data.map(d => d[metricKey][currentDataset]);
    const maxVal = d3.max(values);

    y.domain([0, maxVal]).nice();

    const t = animate ? svg.transition().duration(800) : svg;

    yAxisG.transition(t).call(d3.axisLeft(y));

    yLabel.text(metricConfig[currentMetric].label + " – " + currentDataset);

    bars.transition(t)
        .attr("x", d => x(d.approach))
        .attr("width", x.bandwidth())
        .attr("y", d => y(d[metricKey][currentDataset]))
        .attr("height", d => innerHeight - y(d[metricKey][currentDataset]))
        .attr("fill", d => color(d.approach));
  }

  // 更新 summary：每个数据集的最佳 / 最差方法
  function updateSummary() {
    const metricKey = metricConfig[currentMetric].key;
    const ul = d3.select("#summary-list");
    ul.selectAll("li").remove();

    datasets.forEach(ds => {
      let best = null, worst = null;

      data.forEach(row => {
        const val = row[metricKey][ds];
        if (best === null || val > best.value) best = { method: row.approach, value: val };
        if (worst === null || val < worst.value) worst = { method: row.approach, value: val };
      });

      ul.append("li")
        .text(`${ds}: best = ${best.method} (${best.value.toFixed(2)}), `
            + `worst = ${worst.method} (${worst.value.toFixed(2)})`);
    });
  }

  // 初次绘制（带进入动画）
  updateChart(true);
  updateSummary();

  // --------- 绑定按钮交互 ---------
  d3.selectAll("button.metric-btn").on("click", function() {
    const m = this.getAttribute("data-metric");
    currentMetric = m;

    d3.selectAll("button.metric-btn").classed("active", false);
    d3.select(this).classed("active", true);

    updateChart(true);      // 有 transition
    updateSummary();        // 文本统计跟着变
  });

  d3.selectAll("button.dataset-btn").on("click", function() {
    const ds = this.getAttribute("data-dataset");
    currentDataset = ds;

    d3.selectAll("button.dataset-btn").classed("active", false);
    d3.select(this).classed("active", true);

    updateChart(true);
    // summary 一次显示四个数据集，不需要跟 dataset 按钮一起变
  });
}
</script>
